---
title: "Case-study Right heart catheterization"
author: "Hanchao Zhang, M.S."
output:
  html_document:
    md_extensions: -startnum
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---


\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(warning = F)


library(tableone)
library(tidyverse)
library(survival)
library(survminer)

library(GGally)
library(survRM2)
library(knitr)
library(kableExtra)
library(randomForestSRC)
library(ggRandomForests)
library(pROC)
library(grpreg)
library(pec)
```


## Motivation

The motivation of the analysis is to reveal the association between time to death in 30 days and right heart catheterization (RHC). The main predictor of the model is right heart catheterization, we also adjust the model with all the other variables in the dataset. We want to know whether right heart catheterization actually improve the patients' survival rate in 30 days adjusted by other baseline variables.


[Right heart catheterization (RHC)](https://www.hopkinsmedicine.org/healthlibrary/test_procedures/cardiovascular/right_heart_catheterization_135,40), also known as pulmonary artery catheterization, is an invasive test that mainly checks the working state of the heart by guiding a pulmonary artery (PA) catheter (a small and hollow tube) through the pulmonary artery and into the right chambers of the heart. 

You can find the description of the data from [http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/rhc.html)


## Data Import

By reading the description of the data, we need to exclude several variables in the dataset. The variables including all the enrollment time, discharge time and so on, and the variables with percentage of missing value larger than 20% are also excluded.

We choose 20% as an arbitrary number since we do not want to lose too much information from the whole data set.

We also manully exclude some variables since those variables are not in our interest.


```{r}
rhc <- read.csv('/Users/hanchao/Desktop/rhc.csv')
rhc <- rhc[,-1]
var.vector <- c(
"cat2",
"sadmdte",
"dschdte",
"dthdte",
"lstctdte",
"death",
"surv2md1",
"ptid"
)
var.which <- NULL
for (i in var.vector) {
  var.which[i] <- which(names(rhc) == i)
}

var.which2 <- NULL
for (i in names(rhc)) {
  if( sum(is.na(rhc[,i]))/nrow(rhc) > 0.2 ){
    var.which2[i] <- which(names(rhc) == i)
  }
}

rhc_DF <- rhc[,-c(var.which, var.which2)]
```



## Data Wrangling

### 1. Check the type of the data

We can print the summary and the type of the data first to take a look on the dataset. The summary of the data will give us some characteristics of the data such as mean median quantiles and frequency.

The type of the data can show us whether the variable is stored as factor, string, int or number.



```{r}
summary(rhc_DF)
str(rhc_DF)
```


### 2. Outcome and time variables

Changing the type of the data is also very important for survival analysis, and by checking the data, we also sometimes need to deal with variables with characters. In our data set, the status of having RHC or not is denoted with character. A way to adjust it is to force it into factor directly. However, this kind of factor format sometimes does not work in some of the packages in R. Therefore, we pushed the character into a numeric number and deducted it by 1.

We also used an easy way to change all the variable type to the right one by using a loop function. The main idea is that after observing the summary of the data, we can approximately say that the variables with mean larger than five should be continuous variables, the others should be a factor instead.


```{r}
for (i in names(rhc_DF)) {
  if(is.numeric(rhc_DF[,i])){
    if(mean(rhc_DF[,i], na.rm = T) < 5){
      rhc_DF[,i] <- as.factor((rhc_DF[,i]))
    }else{
      rhc_DF[,i] <- ((rhc_DF[,i]))
    }
  }
}
rhc_DF$dth30 <- as.numeric(rhc_DF$dth30) - 1
rhc_DF$swang1 <- as.numeric(rhc_DF$swang1) - 1
rhc_DF$alb1 <- as.numeric(as.character(rhc_DF$alb1))


rhc_DF$bili1 <- as.numeric(as.character(rhc_DF$bili1))
rhc_DF$crea1 <-  as.numeric(as.character(rhc_DF$crea1))
rhc_DF$pot1 <- as.numeric(as.character(rhc_DF$pot1))
str(rhc_DF)
```


## Exploratory data analysis

For the numeric variables, we should check the usually before doing any test. QQ-plot is an easy way to test normality, there are several tests, Shapiro for example, but we won't use it here, and those tests are not frequently used anyway.



```{r, fig.height=7}
nonnormal <- NULL
par(mfrow = c(4,5))
for (i in 1:ncol(rhc_DF)) {
  if( is.numeric(rhc_DF[,i]) ){
    qqnorm(rhc_DF[,i], main = names(rhc_DF)[i])
    qqline(rhc_DF[,i])
    nonnormal[i] <- names(rhc_DF)[i]
  }
}
```

### 1. Data Description


| Tables   |      Are      |
|---------------------------------|---------------------------------|
| Age                                  | Age                                                                                                                                                                 |
| Sex                                  | Sex                                                                                                                                                                 |
| Race                                 | Race                                                                                                                                                                |
| Edu                                  | Years of education                                                                                                                                                  |
| Income                               | Income                                                                                                                                                              |
| Ninsclas                             | Medical insurance                                                                                                                                                   |
| Cat1                                 | Primary disease category                                                                                                                                            |
| Cat2                                 | Secondary disease category                                                                                                                                          |
| Categories of admission diagnosis:   |                                                                                                                                                                     |
| Resp                                 | Respiratory Diagnosis                                                                                                                                               |
| Card                                 | Cardiovascular Diagnosis                                                                                                                                            |
| Neuro                                | Neurological Diagnosis                                                                                                                                              |
| Gastr                                | Gastrointestinal Diagnosis                                                                                                                                          |
| Renal                                | Renal Diagnosis                                                                                                                                                     |
| Meta                                 | Metabolic Diagnosis                                                                                                                                                 |
| Hema                                 | Hematologic Diagnosis                                                                                                                                               |
| Seps                                 | Sepsis Diagnosis                                                                                                                                                    |
| Trauma                               | Trauma Diagnosis                                                                                                                                                    |
| Ortho                                | Orthopedic Diagnosis                                                                                                                                                |
|                                      |                                                                                                                                                                     |
| Adld3p                               | ADL                                                                                                                                                                 |
| Das2d3pc                             | DASI ( Duke Activity Status Index)                                                                                                                                  |
| Dnr1                                 | DNR status on day1                                                                                                                                                  |
| Ca                                   | Cancer                                                                                                                                                              |
| Surv2md1                             | Support model estimate of the prob. of surviving 2 months                                                                                                           |
| Aps1                                 | APACHE score                                                                                                                                                        |
| Scoma1                               | Glasgow Coma Score                                                                                                                                                  |
| Wtkilo1                              | Weight                                                                                                                                                              |
| Temp1                                | Temperature                                                                                                                                                         |
| Meanbp1                              | Mean blood pressure                                                                                                                                                 |
| Resp1                                | Respiratory rate                                                                                                                                                    |
| Hrt1                                 | Heart rate                                                                                                                                                          |
| Pafi1                                | PaO2/FIO2 ratio                                                                                                                                                     |
| Paco21                               | PaCo2                                                                                                                                                               |
| Ph1                                  | PH                                                                                                                                                                  |
| Wblc1                                | WBC                                                                                                                                                                 |
| Hema1                                | Hematocrit                                                                                                                                                          |
| Sod1                                 | Sodium                                                                                                                                                              |
| Pot1                                 | Potassium                                                                                                                                                           |
| Crea1                                | Creatinine                                                                                                                                                          |
| Bili1                                | Bilirubin                                                                                                                                                           |
| Alb1                                 | Albumin                                                                                                                                                             |
| Urin1                                | Urine output                                                                                                                                                        |
| Categories of comorbidities illness: |                                                                                                                                                                     |
| Cardiohx                             | Acute MI, Peripheral Vascular Disease, Severe Cardiovascular Symptoms (NYHA-Class III), Very Severe Cardiovascular Symptoms (NYHA-Class IV)                         |
| Chfhx                                | Congestive Heart Failure                                                                                                                                            |
| Dementhx                             | Dementia, Stroke or Cerebral Infarct, Parkinsonâ€™s Disease                                                                                                           |
| Psychhx                              | Psychiatric History, Active Psychosis or Severe Depression                                                                                                          |
| Chrpulhx                             | Chronic Pulmonary Disease, Severe Pulmonary Disease, Very Severe Pulmonary Disease                                                                                  |
| Renalhx                              | Chronic Renal Disease, Chronic Hemodialysis or Peritoneal Dialysis                                                                                                  |
| Liverhx                              | Cirrhosis, Hepatic Failure                                                                                                                                          |
| Gibledhx                             | Upper GI Bleeding                                                                                                                                                   |
| Malighx                              | Solid Tumor, Metastatic Disease, Chronic Leukemia/Myeloma, Acute Leukemia, Lymphoma                                                                                 |
| Immunhx                              | Immunosupperssion, Organ Transplant, HIV Positivity, Diabetes Mellitus Without End Organ Damage, Diabetes Mellitus With End Organ Damage, Connective Tissue Disease |
| Transhx                              | Transfer (> 24 Hours) from Another Hospital                                                                                                                         |
| Amihx                                | Definite Myocardial Infarction                                                                                                                                      |
|                                      |                                                                                                                                                                     |
| Swang1                               | Right Heart Catheterization (RHC)                                                                                                                                   |
| Sadmdte                              | Study Admission Date                                                                                                                                                |
| Dthdte                               | Date of Death                                                                                                                                                       |
| Lstctdte                             | Date of Last Contact                                                                                                                                                |
| Dschdte                              | Hospital Discharge Date                                                                                                                                             |
| Death                                | Death at any time up to 180 Days                                                                                                                                    |
| Ptid                                 | Patient ID                




```{r, results='hide'}
CreateTableOne(data = rhc_DF, strata = 'swang1') %>%
  print(nonnormal = nonnormal) -> tblprint2

tblprint2[c(2, 12, 16:27, 29, 52:53, 60:70, 74),4] <- 'Chi-sq'
tblprint2[,4][tblprint2[,4] == 'nonnorm'] <- 'Wilcoxon'
```


### 2. Demographic

```{r}
kable(tblprint2 [-c(30,39),], "html", caption = "Stritified by Right Heart Catheterization", booktabs = T) %>%
  kable_styling('responsive') %>%
  add_indent(c(3:11, 13:15,52:57,69:71,73:76 ))

```



The demographics can help us understand the one to one relation between right heart catheterization and other symptoms. 




```{r}
#ggpairs(rhc_DF, title = "Within Academic Variables")

```




### 3. Kaplan Meier (non-parametric)


The Kaplan Meier estimator is a non-parametric method that used to estimate the survival probability. It is often used to estimate the survival rate stratified by some treatment of interest.


#### What is Y and X

description of what model estimating and survival probability



```{r}
fit <- survfit(Surv(t3d30, dth30) ~ swang1, data = rhc_DF)
```

The t3d30 is the survival time of each patients and dth30 is the dummy variable that indicate wheter the patient survived or dead in 30 days.



```{r}
ggsurvplot(
   fit,                     # survfit object with calculated statistics.
   data = rhc_DF,           # data used to fit survival curves. 
   risk.table = F,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
   risk.table.y.text.col = T, # colour risk table text annotations.
   risk.table.y.text = FALSE, # show bars instead of names in text annotations
                            # in legend of risk table
  ylim = c(0.6,1)
)



```



The Kaplan Meier plot shows us the survival rate without stratified by having the right heart catheterization without any covariates adjustment.

The x-axis is the survival time, and the y-axis is the survival probability. It looks like a step function since the probability changes for each day.

For example, at the beginning, all the patients survived. The survival probability of patients having the right catheterization is about 77% and 82% for patients not having the right catheterization. The survival rate changes to 67% in 20 days for those had right heart catheterization and 74% for those had not had a right heart catheterization. Finally, in 30 days, the survival becomes 62% for those who had RHC and 70% for those who had not had RHC.

The results seem to show that having the RHC actually decrease the patients' survival probability. Does it make sense to give patients this surgery in the future? You would probably say that we shouldn't recommend patients this surgery anymore. However, does it make sense? Why are doctors still recommending patients having this surgery?



## Proportional Hazard Model (Cox model)

In logistic regression, we know that whether an event is going to happen or not, and you could see survival analysis as an updated version of logistic regression where you could know when that even would happen.

Cox model, also known as proportional hazards models are a class of parametric survival models in statistics. It includes variables like the time that passes, the event occurs and other covariates that used to adjust the association of survival rate and time.

A fundamental assumption of the cox model is that the model assumes the hazard is a constant with the time passing by.

### 1. Right censoring

We would only introduce right censoring in our case study, for the right censoring, we just know that the patients are even-free up until the censoring time.

### 2. How do we record survival data

+ T = time to death

+ C = censoring time

However, we can only observe the $Y = min(C, T)$

it means that whether the patients dead or they drop the experiment


### 3. Survival Function

$$S(t) = P(T>t) = 1 - F(t)$$


To simplify, the survival rate equal to the probability of surviving at time t or one minus the probability of dying at time t



### 4. Hazard Function

$$H(t) = P(T = t|T \ge t)$$

It means that 

$$H(t) = \frac{number~ of~ individuals~ experiencing~ an~ event~ in~ interval~ beginning~ at~ t}{an~ event~ in~ interval~ beginning~ at~ time t \times (interval~ width)}$$

$$H(t) = \frac{f(t)}{S(t-1)}$$


wehre $f(t) = p(t=T)$


### 5. Proporites

+ non-increasing

+ survival rate at time 0 equal to 1

+ survival probability at time infinity equal to 0

+ the hazard function assumes proportional hazard meaning that the hazard is constant


We esitmate the hazard by the function:

$$H(t) = H_0(t) e^{\beta X}$$

where $\beta$ is the coefficients matrix and the X is the covariates matrix.





```{r}
fit1 <- coxph(Surv(t3d30,dth30) ~ . + .^2 ,data = rhc_DF)
fit1
```


We fit the model with all the variables and their pairwise interactions. Since we have too many variables, we won't interpret each of them. Just notice that if the coefficient is larger than 0, the variable will increase the survival probability and vice versa.


### 6. Adjusted Survival Plot

We could estimate the new survival plot by inputting the main predictor RHC, we first code all RHC as 0, predict the survival rate and input all RHC as 1, and predict the survival rate again.


```{r}
rhc0 <- rhc1 <- rhc_DF
rhc0$swang1 <- 0
rhc1$swang1 <- 1
```



After extracting the survival rate, we can see that the effect of Right Heart Catheterization changed. The survival rate of the patients having the RHC is actually higher than those who don't have RHC. The red line is now above the blue line.




```{r}
time1 <- survfit(fit1, newdata = rhc0)$surv
time2 <- survfit(fit1, newdata = rhc1)$surv

rowMeans(time1) %>%
  plot(type = "l", col = "blue", main = 'RMST-Cox model', xlab = 'Days', ylab = 'Survival Rate')
rowMeans(time2) %>%
  lines(col = "red")
legend('topright', c('No RHC','RHC'), col = c('blue','red'), pch = 20)

dat.time <- data.frame(time1 = rowMeans(time1), time2 = rowMeans(time2))
ggplot(dat.time) +
  geom_step(aes(x =1:length(dat.time$time1) ,y = time1, col = 'red')) +
  geom_step(aes(x =1:length(dat.time$time2) ,y = time2, col = 'blue')) +
  theme_survminer() +
  theme_minimal() + labs(colour="Strata", x = "survival time", y = "probability", colour = 'RHC',  title = 'Survival Plot') +
  scale_color_manual(labels = c("No RHC", "Yes RHC"), values = c("red", "blue"))

  


```

Why does it happen?

When we see the Kaplan Meier plot, the reason that the people who had the RHC having less survival probability are that they are sicker than others. They need the surgery because they are sicker. It makes them less possible to survival in general, however, after adjusting the baseline variables, we can see that RHC is actually helping patients to live longer.



